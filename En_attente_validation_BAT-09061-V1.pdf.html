<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Validation de BAT</title>

  <!-- Leaflet (carte) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    body{
      margin:0;font-family:Arial, sans-serif;
      background:url('banniere-linkedin-brice2025.svg') no-repeat center center fixed;
      background-size:cover;
      display:flex;justify-content:center;align-items:center;min-height:100vh;
    }
    .container{
      background:rgba(255,255,255,.95);
      padding:20px;border-radius:12px;max-width:900px;width:100%;
    }
    h1{margin:0 0 8px;text-align:center;color:#333}
    iframe{
      width:100%;height:500px;border:none;margin:20px 0;overflow:auto;background:#fff;border-radius:8px;
    }
    textarea{
      width:100%;padding:10px;margin:10px 0;resize:vertical;border-radius:6px;border:1px solid #ccc;
    }
    .buttons{display:flex;gap:10px}
    button{
      flex:1;padding:12px;font-size:16px;font-weight:700;border:none;border-radius:6px;cursor:pointer
    }
    .approve{background:#28a745;color:#fff}
    .reject{background:#dc3545;color:#fff}

    .section-title{margin:18px 0 8px;font-weight:700}
    .grid{display:grid;grid-template-columns:1fr;gap:10px}
    @media(min-width:680px){.grid-2{grid-template-columns:1fr 1fr}.grid-3{grid-template-columns:1fr 1fr 1fr}}
    label{display:block;font-weight:600;margin-bottom:6px}
    .req::after{content:" *";color:#dc3545;font-weight:700}
    input[type="text"],input[type="tel"],input[type="email"],select{
      width:100%;padding:10px;border:1px solid #ccc;border-radius:6px;background:#fff
    }
    .err{color:#dc3545;font-size:12px;display:none;margin-top:4px}
    input.error{border-color:#dc3545;background:#fff6f6}
    .hint{font-size:12px;color:#666;margin-top:2px}
    hr{border:none;border-top:1px solid #e5e7eb;margin:18px 0}
    .locked{opacity:.6;pointer-events:none}

    /* Relais */
    #relay-list > div:hover{background:#f9fafb}
    .chip{
      display:inline-block;padding:4px 8px;border-radius:999px;background:#eef2ff;color:#3730a3;
      font-size:12px;font-weight:700;margin-left:6px
    }
  </style>
</head>
<body>
  <div class="container" id="page">
    <h1>üñäÔ∏è Validation de votre BAT</h1>

    <iframe id="batFrame" src="https://drive.google.com/file/d/17I5TWL85p_NHArMJipNgco5Pkb8W3sSi/preview" allowfullscreen></iframe>

    <div>
      <div class="section-title">üì¨ Adresse de livraison</div>

      <div class="grid grid-2">
        <div>
          <label for="addr-societe" class="req">Nom de la soci√©t√©</label>
          <input id="addr-societe" type="text" autocomplete="organization" required value="CLIENT TEST">
          <div class="err"></div>
        </div>
        <div>
          <label for="addr-nom" class="req">Nom du destinataire</label>
          <input id="addr-nom" type="text" autocomplete="name" required value="forestier Leo">
          <div class="err"></div>
        </div>
      </div>

      <div class="grid">
        <div>
          <label for="addr-rue" class="req">Adresse (rue)</label>
          <input id="addr-rue" type="text" autocomplete="address-line1" required value="   ">
          <div class="err"></div>
          <div class="hint">L‚Äôadresse sera automatiquement r√©partie sur 2 lignes si n√©cessaire.</div>
        </div>
      </div>

      <div class="grid" id="addr-comp-wrap">
        <div>
          <label for="addr-comp">Compl√©ment d‚Äôadresse</label>
          <input id="addr-comp" type="text" autocomplete="address-line2" value="">
        </div>
      </div>

      <div class="grid grid-3">
        <div>
          <label for="addr-cp" class="req">Code postal</label>
          <input id="addr-cp" type="text" inputmode="numeric" autocomplete="postal-code" required value="">
          <div class="err"></div>
        </div>
        <div>
          <label for="addr-ville" class="req">Ville</label>
          <input id="addr-ville" type="text" autocomplete="address-level2" required value="">
          <div class="err"></div>
        </div>
        <div>
          <label for="addr-tel" class="req">T√©l√©phone</label>
          <input id="addr-tel" type="tel" autocomplete="tel" required value="">
          <div class="err"></div>
        </div>
      </div>

      <div class="grid">
        <div>
          <label for="addr-mail" class="req">Adresse e-mail</label>
          <input id="addr-mail" type="email" autocomplete="email" required value="louise@ennotex.fr">
          <div class="err"></div>
        </div>
      </div>

      <div class="hint">Les champs marqu√©s d‚Äôun * sont obligatoires.</div>
    </div>

    <hr/>

    <!-- MODE LIVRAISON -->
    <div class="section-title">üì¶ Mode de livraison</div>

    <div class="grid grid-2">
      <div>
        <label for="delivery-mode" class="req">Choix</label>
        <select id="delivery-mode">
          <option value="home" selected>Livraison standard (adresse)</option>
          <option value="gls_relay">Point relais GLS</option>
        </select>
        <div class="hint">Si vous choisissez un point relais, vous devrez en s√©lectionner un dans la liste/carte.</div>
      </div>

      <div id="relay-selected-box" style="display:none;border:1px solid #e5e7eb;border-radius:8px;padding:10px;background:#f9fafb">
        <div style="font-weight:700">Point relais s√©lectionn√© ‚úÖ</div>
        <div id="relay-selected-text" style="font-size:14px;margin-top:6px"></div>
      </div>
    </div>

    <div id="relay-wrap" style="display:none;margin-top:10px">
      <div class="section-title">üîé Rechercher un point relais GLS</div>

      <div class="grid grid-2">
        <div>
          <label for="relay-search">Adresse / Code postal / Ville</label>
          <input id="relay-search" type="text" placeholder="ex : 75011 Paris ou 10 rue ..." />
          <div class="hint">Astuce : vous pouvez saisir juste un code postal.</div>
        </div>
        <div style="display:flex;align-items:end;gap:10px">
          <button type="button" id="relay-btn" style="width:100%;padding:12px;font-weight:700;border:none;border-radius:6px;cursor:pointer;background:#111827;color:#fff">
            Rechercher
          </button>
        </div>
      </div>

      <div class="grid grid-2" style="margin-top:10px">
        <div>
          <div style="font-weight:700;margin-bottom:8px">üó∫Ô∏è Carte</div>
          <div id="map" style="width:100%;height:340px;border-radius:8px;border:1px solid #e5e7eb;background:#fff"></div>
        </div>

        <div>
          <div style="font-weight:700;margin-bottom:8px">üìÉ Liste</div>
          <div id="relay-list" style="max-height:340px;overflow:auto;border:1px solid #e5e7eb;border-radius:8px;background:#fff"></div>
        </div>
      </div>

      <div class="hint" style="margin-top:8px">
        Cliquez sur un point relais dans la liste ou sur la carte pour le s√©lectionner.
      </div>
    </div>

    <hr/>

    <textarea id="comment" placeholder="Veuillez indiquer la raison du refus..."></textarea>

    <div class="buttons">
      <button class="approve" id="btn-approve" onclick="submitBAT(true)" disabled>‚úÖ Je valide ce BAT</button>
      <button class="reject"  id="btn-reject"  onclick="submitBAT(false)" >‚ùå Je refuse ce BAT</button>
    </div>
  </div>

  <script>
    const approveBtn = document.getElementById('btn-approve');
    const rejectBtn  = document.getElementById('btn-reject');
    const commentBox = document.getElementById('comment');
    const page       = document.getElementById('page');
    const batKey     = "bat_status_En_attente_validation_BAT-09061-V1.pdf";
    let isSending    = false;

    // ====== CONFIG: Webhook Make pour recherche relais ======
    // Cr√©e un scenario Make "Search Parcelshops" et mets l'URL ici.
    const MAKE_SEARCH_WEBHOOK_URL = "https://hook.eu1.make.com/XXXXXXXXXXXXXX";

    // ====== STATE RELAIS ======
    let relayMap = null;
    let relayMarkers = [];
    let selectedParcelshop = null;
    let lastRelayResults = [];

    function splitAddressToTwoLines(line1, line2, maxLen){
      const full = ((line1 || "") + " " + (line2 || "")).replace(/\s+/g, " ").trim();
      if(full.length <= maxLen) return { a1: full, a2: "" };

      let cut = full.lastIndexOf(" ", maxLen);
      if (cut === -1 || cut < 1) cut = maxLen;

      return {
        a1: full.slice(0, cut).trim(),
        a2: full.slice(cut).trim()
      };
    }

    function applyAddressSplitLive(){
      const rue  = document.getElementById('addr-rue');
      const comp = document.getElementById('addr-comp');
      const rueNorm = (rue.value || "").replace(/\s+/g," ").trim();

      if(rueNorm.length > 35){
        const parts = splitAddressToTwoLines(rue.value, comp.value, 35);
        rue.value = parts.a1;
        comp.value = parts.a2;
      }
    }

    function applyAddressSplitForce(){
      const rue  = document.getElementById('addr-rue');
      const comp = document.getElementById('addr-comp');
      const parts = splitAddressToTwoLines(rue.value, comp.value, 35);
      rue.value = parts.a1;
      comp.value = parts.a2;
    }

    document.addEventListener('DOMContentLoaded', ()=>{
      const wasSubmitted = localStorage.getItem(batKey) === 'submitted';
      if (wasSubmitted) lockForm();

      // Nettoie placeholders non remplac√©s
      document.querySelectorAll('input').forEach(inp=>{
        const v = (inp.value || '').replace(/\s+/g,' ').trim();
        if (/\{\{.+\}\}/.test(v)) inp.value = '';
        else inp.value = v;
      });

      // split initial
      applyAddressSplitForce();

      // split live
      document.getElementById('addr-rue').addEventListener('input', ()=>{
        applyAddressSplitLive();
        updateApproveState();
      });
      document.getElementById('addr-comp').addEventListener('input', ()=>{
        updateApproveState();
      });

      attachValidation();

      // Relais UI
      initRelayUI();

      updateApproveState();
    });

    function lockForm(){
      page.classList.add('locked');
      approveBtn.disabled = true;
      rejectBtn.disabled = true;
      commentBox.disabled = true;
      document.querySelectorAll('input,select,button').forEach(i=>i.disabled = true);
    }

    function setError(el, msg){
      el.classList.add('error');
      const err = el.parentElement.querySelector('.err');
      if(err){ err.textContent = msg; err.style.display='block'; }
    }
    function clearError(el){
      el.classList.remove('error');
      const err = el.parentElement.querySelector('.err');
      if(err){ err.textContent=''; err.style.display='none'; }
    }

    function validateAddress(focusOnError){
      const f = {
        societe: document.getElementById('addr-societe'),
        nom:     document.getElementById('addr-nom'),
        rue:     document.getElementById('addr-rue'),
        cp:      document.getElementById('addr-cp'),
        ville:   document.getElementById('addr-ville'),
        tel:     document.getElementById('addr-tel'),
        mail:    document.getElementById('addr-mail')
      };
      Object.values(f).forEach(clearError);
      let ok = true;

      if(!f.societe.value.trim()){ setError(f.societe,'Requis'); ok=false; }
      if(!f.nom.value.trim()){ setError(f.nom,'Requis'); ok=false; }
      if(!f.rue.value.trim()){ setError(f.rue,'Requis'); ok=false; }

      if(f.rue.value.trim().length > 35){ setError(f.rue,'Adresse trop longue'); ok=false; }

      const cpVal = f.cp.value.trim();
      if(!/^\d{5}$/.test(cpVal)){ setError(f.cp,'Code postal invalide (5 chiffres)'); ok=false; }

      if(!f.ville.value.trim()){ setError(f.ville,'Requis'); ok=false; }

      const telVal = f.tel.value.trim().replace(/\s+/g,'');
      if(!/^[0-9+][0-9]{8,14}$/.test(telVal)){ setError(f.tel,'T√©l√©phone invalide'); ok=false; }

      const mailVal = f.mail.value.trim();
      if(!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(mailVal)){ setError(f.mail,'E-mail invalide'); ok=false; }

      if(!ok && focusOnError){
        const firstErr = document.querySelector('input.error');
        if(firstErr){ firstErr.scrollIntoView({behavior:'smooth',block:'center'}); firstErr.focus(); }
      }
      return ok;
    }

    function attachValidation(){
      document.querySelectorAll('#addr-societe,#addr-nom,#addr-rue,#addr-comp,#addr-cp,#addr-ville,#addr-tel,#addr-mail')
        .forEach(inp=>{
          inp.addEventListener('input', updateApproveState);
          inp.addEventListener('blur',  updateApproveState);
        });
    }

    function deliveryMode(){
      return document.getElementById('delivery-mode').value;
    }

    function relayRequiredOk(){
      if(deliveryMode() !== 'gls_relay') return true;
      return !!(selectedParcelshop && selectedParcelshop.id);
    }

    function updateApproveState(){
      applyAddressSplitForce();
      const okAddr = validateAddress(false);
      const okRelay = relayRequiredOk();
      const ok = okAddr && okRelay;

      approveBtn.disabled = !ok;
      approveBtn.style.opacity = ok ? '1' : '.6';
      approveBtn.style.cursor  = ok ? 'pointer' : 'not-allowed';
    }

    function addressPayload(){
      return {
        societe:  document.getElementById('addr-societe').value.trim(),
        nom:      document.getElementById('addr-nom').value.trim(),
        adresse:  document.getElementById('addr-rue').value.trim(),
        code_postal: document.getElementById('addr-cp').value.trim(),
        ville:    document.getElementById('addr-ville').value.trim(),
        telephone:document.getElementById('addr-tel').value.trim(),
        email:    document.getElementById('addr-mail').value.trim(),
        adresse_ligne2: (document.getElementById('addr-comp')?.value || "").trim(),
        delivery_mode: deliveryMode(),
        parcelshop: (deliveryMode() === 'gls_relay') ? (selectedParcelshop || null) : null
      };
    }

    // ====== RELAIS UI + MAP ======
    function initRelayUI(){
      const modeSel = document.getElementById('delivery-mode');
      const wrap = document.getElementById('relay-wrap');
      const btn = document.getElementById('relay-btn');

      modeSel.addEventListener('change', ()=>{
        const isRelay = (modeSel.value === 'gls_relay');
        wrap.style.display = isRelay ? 'block' : 'none';

        if(!isRelay){
          selectedParcelshop = null;
          lastRelayResults = [];
          document.getElementById('relay-selected-box').style.display = 'none';
          document.getElementById('relay-list').innerHTML = '';
          if(relayMap) clearMarkers();
        }else{
          initMapIfNeeded();
          // Option: auto search bas√© sur CP/Ville si pr√©sents
          searchRelay();
        }
        updateApproveState();
      });

      btn.addEventListener('click', searchRelay);
    }

    function initMapIfNeeded(){
      if(relayMap) return;

      relayMap = L.map('map').setView([48.8566, 2.3522], 12); // Paris par d√©faut
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap'
      }).addTo(relayMap);
    }

    function clearMarkers(){
      relayMarkers.forEach(m => relayMap.removeLayer(m));
      relayMarkers = [];
    }

    function setSelectedParcelshop(p){
      selectedParcelshop = p;

      const box = document.getElementById('relay-selected-box');
      const txt = document.getElementById('relay-selected-text');
      box.style.display = 'block';

      const line = `${p.name} ‚Äî ${p.address1}${p.address2 ? " " + p.address2 : ""}, ${p.zip} ${p.city}`;
      txt.textContent = line;

      updateApproveState();
    }

    function renderRelayList(items){
      const list = document.getElementById('relay-list');

      if(!items.length){
        list.innerHTML = `<div style="padding:12px">Aucun point relais trouv√©. Essayez un autre code postal / ville.</div>`;
        return;
      }

      list.innerHTML = items.map((p, idx)=>`
        <div data-idx="${idx}" style="padding:10px;border-bottom:1px solid #f1f5f9;cursor:pointer">
          <div style="font-weight:700">
            ${escapeHtml(p.name || "Point Relais")}
            ${(p.distance_km!=null) ? `<span class="chip">${Number(p.distance_km).toFixed(1)} km</span>` : ``}
          </div>
          <div style="font-size:13px;color:#374151">${escapeHtml(p.address1 || "")}${p.address2 ? " " + escapeHtml(p.address2) : ""}</div>
          <div style="font-size:13px;color:#374151">${escapeHtml(p.zip || "")} ${escapeHtml(p.city || "")}</div>
          ${p.hours ? `<div style="font-size:12px;color:#6b7280;margin-top:4px">${escapeHtml(p.hours)}</div>` : ``}
        </div>
      `).join('');

      list.querySelectorAll('[data-idx]').forEach(el=>{
        el.addEventListener('click', ()=>{
          const p = items[parseInt(el.getAttribute('data-idx'),10)];
          setSelectedParcelshop(p);
          if(p.lat != null && p.lng != null){
            relayMap.setView([p.lat, p.lng], 15);
          }
        });
      });
    }

    function renderRelayMap(items){
      initMapIfNeeded();
      clearMarkers();

      const withGeo = items.filter(p => typeof p.lat === 'number' && typeof p.lng === 'number');
      if(!withGeo.length){
        // Pas de geo: on garde la carte vide, la liste suffit
        return;
      }

      const bounds = [];
      withGeo.forEach(p=>{
        const marker = L.marker([p.lat, p.lng]).addTo(relayMap);
        marker.bindPopup(`<b>${escapeHtml(p.name || "")}</b><br>${escapeHtml(p.address1 || "")}<br>${escapeHtml(p.zip || "")} ${escapeHtml(p.city || "")}`);
        marker.on('click', ()=> setSelectedParcelshop(p));
        relayMarkers.push(marker);
        bounds.push([p.lat, p.lng]);
      });

      relayMap.fitBounds(bounds, { padding: [20, 20] });
    }

    async function searchRelay(){
      // Seulement si mode relais
      if(deliveryMode() !== 'gls_relay') return;

      initMapIfNeeded();

      // reset s√©lection √† chaque recherche
      selectedParcelshop = null;
      document.getElementById('relay-selected-box').style.display = 'none';
      updateApproveState();

      const q = (document.getElementById('relay-search').value || '').trim();

      const fallback = {
        zip: document.getElementById('addr-cp').value.trim(),
        city: document.getElementById('addr-ville').value.trim(),
        country: "FR"
      };

      const payload = q
        ? { query: q, country: "FR" }
        : { ...fallback };

      // UI loading
      document.getElementById('relay-list').innerHTML = `<div style="padding:12px">Recherche en cours‚Ä¶</div>`;
      clearMarkers();

      try{
        const res = await fetch(MAKE_SEARCH_WEBHOOK_URL, {
          method:"POST",
          headers:{ "Content-Type":"application/json" },
          body: JSON.stringify(payload)
        });

        // Si Make renvoie pas du JSON => erreur
        const data = await res.json();

        if(!data || data.ok !== true){
          document.getElementById('relay-list').innerHTML = `<div style="padding:12px">Erreur : recherche impossible.</div>`;
          return;
        }

        const items = Array.isArray(data.parcelshops) ? data.parcelshops : [];
        lastRelayResults = items;

        renderRelayList(items);
        renderRelayMap(items);

      }catch(e){
        document.getElementById('relay-list').innerHTML = `<div style="padding:12px">Erreur r√©seau. R√©essayez.</div>`;
      }
    }

    function escapeHtml(str){
      return String(str || "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    // ====== SUBMIT BAT ======
    function submitBAT(isValid){
      if (localStorage.getItem(batKey) === 'submitted') { lockForm(); return; }
      if (isSending) return;

      applyAddressSplitForce();

      if(isValid){
        if(!validateAddress(true)){ updateApproveState(); return; }
        if(!relayRequiredOk()){
          // si relais non choisi
          alert("Veuillez s√©lectionner un point relais GLS avant de valider.");
          return;
        }
      }

      isSending = true;
      approveBtn.disabled = true;
      rejectBtn.disabled  = true;

      fetch("https://hook.eu1.make.com/1845ruicf13lufrf3jtnyn2438owof76",{
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body:JSON.stringify({
          status: isValid ? "valid√©" : "refus√©",
          commentaire: commentBox.value,
          bat: "En_attente_validation_BAT-09061-V1.pdf",
          Pays:"France",
          Express:"non",
          Point_relais: (deliveryMode() === "gls_relay") ? "oui" : "non",
          Retrait_showroom:"non",
          Besoin_sp√©:"non",
          GLS:"oui",
          id_dev_sellsy: "53124449",
          id_bat_slide: "19kaxG_sCe3Wez2XwP0zM4sjAI5rACW1LfEcu6OgGy0c",
          id_opp_sellsy: "11238102",
          number_devis: "DEV-20260129-09061",
          company_name: "CLIENT TEST",
          name_client: "CLIENT TEST",
          id_company:"39021759",
          mail_client: "louise@ennotex.fr",
          prenom:"Leo",
          shipping_address: addressPayload()
        })
      }).then(()=>{
        localStorage.setItem(batKey, "submitted");
        lockForm();
        window.location.href = isValid ? "confirmation.html" : "refus.html";
      }).catch(()=>{
        isSending = false;
        approveBtn.disabled = false;
        rejectBtn.disabled  = false;
        alert("√âchec d'envoi, r√©essayez.");
      });
    }
  </script>
</body>
</html>