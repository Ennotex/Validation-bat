<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Validation de BAT</title>
  <style>
    body{
      margin:0;font-family:Arial, sans-serif;
      background:url('banniere-linkedin-brice2025.svg') no-repeat center center fixed;
      background-size:cover;
      display:flex;justify-content:center;align-items:center;min-height:100vh;
    }
    .container{
      background:rgba(255,255,255,.95);
      padding:20px;border-radius:12px;max-width:800px;width:100%;
    }
    h1{margin:0 0 8px;text-align:center;color:#333}
    iframe{
      width:100%;height:500px;border:none;margin:20px 0;overflow:auto;background:#fff;border-radius:8px;
    }
    textarea{
      width:100%;padding:10px;margin:10px 0;resize:vertical;border-radius:6px;border:1px solid #ccc;
    }
    .buttons{display:flex;gap:10px}
    button{
      flex:1;padding:12px;font-size:16px;font-weight:700;border:none;border-radius:6px;cursor:pointer
    }
    .approve{background:#28a745;color:#fff}
    .reject{background:#dc3545;color:#fff}

    .section-title{margin:18px 0 8px;font-weight:700}
    .grid{display:grid;grid-template-columns:1fr;gap:10px}
    @media(min-width:680px){.grid-2{grid-template-columns:1fr 1fr}.grid-3{grid-template-columns:1fr 1fr 1fr}}
    label{display:block;font-weight:600;margin-bottom:6px}
    .req::after{content:" *";color:#dc3545;font-weight:700}

    input[type="text"],input[type="tel"],input[type="email"],select{
      width:100%;padding:10px;border:1px solid #ccc;border-radius:6px;background:#fff
    }
    .err{color:#dc3545;font-size:12px;display:none;margin-top:4px}
    input.error, select.error{border-color:#dc3545;background:#fff6f6}
    .hint{font-size:12px;color:#666;margin-top:2px}
    hr{border:none;border-top:1px solid #e5e7eb;margin:18px 0}
    .locked{opacity:.6;pointer-events:none}
    .cc-badge{font-size:12px;color:#111;background:#f3f4f6;border:1px solid #e5e7eb;border-radius:999px;padding:4px 10px;display:inline-block}
  </style>
</head>

<body>
  <div class="container" id="page">
    <h1>üñäÔ∏è Validation de votre BAT</h1>

    <iframe id="batFrame" src="https://drive.google.com/file/d/1D1qKeOrhVu710MzqK0oJiSMrMCBOnpjE/preview" allowfullscreen></iframe>

    <div>
      <div class="section-title">üì¨ Adresse de livraison (√©tranger)</div>

      <div class="grid grid-2">
        <div>
          <label for="addr-societe" class="req">Nom de la soci√©t√©</label>
          <input id="addr-societe" type="text" autocomplete="organization" required value="CLIENT TEST">
          <div class="err"></div>
        </div>
        <div>
          <label for="addr-nom" class="req">Nom du destinataire</label>
          <input id="addr-nom" type="text" autocomplete="name" required value="forestier Leo">
          <div class="err"></div>
        </div>
      </div>

      <!-- PAYS -->
      <div class="grid">
        <div>
          <label for="addr-country" class="req">Pays</label>
          <select id="addr-country" required>
            <option value="">‚Äî S√©lectionner ‚Äî</option>
            <option value="DE">Allemagne</option>
            <option value="AT">Autriche</option>
            <option value="DZ">Belgique</option>
            <option value="BG">Bulgarie</option>
            <option value="HR">Croatie</option>
            <option value="DK">Danemark</option>
            <option value="ES">Espagne</option>
            <option value="EE">Estonie</option>
            <option value="FI">Finlande</option>
            <option value="GR">Gr√®ce</option>
            <option value="HU">Hongrie</option>
            <option value="IE">R√©p. Irlande</option>
            <option value="IT">Italie</option>
            <option value="LV">Lettonie</option>
            <option value="LT">Lituanie</option>
            <option value="LU">Luxembourg</option>
            <option value="MT">Malte</option>
            <option value="NL">Pays Bas</option>
            <option value="PL">Pologne</option>
            <option value="PT">Portugal</option>
            <option value="RO">Roumanie</option>
            <option value="CZ">R√©p. Tch√®que</option>
            <option value="SK">Slovaquie</option>
            <option value="SI">Slov√©nie</option>
            <option value="SE">Su√®de</option>
          </select>
          <div class="err"></div>
          <div class="hint">Code pays s√©lectionn√© : <span class="cc-badge" id="cc-display">‚Äî</span></div>
        </div>
      </div>

      <!-- ‚úÖ Adresse (non bloqu√©e) -->
      <div class="grid">
        <div>
          <label for="addr-rue" class="req">Adresse</label>
          <!-- ‚úÖ on retire maxlength pour ne plus bloquer la saisie -->
          <input id="addr-rue" type="text" autocomplete="address-line1" required
                 value="   ">
          <div class="err"></div>
          <div class="hint">L‚Äôadresse sera automatiquement r√©partie sur 2 lignes si n√©cessaire.</div>
        </div>
      </div>

      <!-- ‚úÖ Compl√©ment affich√© tout le temps -->
      <div class="grid" id="addr-comp-wrap">
        <div>
          <label for="addr-comp">Compl√©ment d‚Äôadresse</label>
          <input id="addr-comp" type="text" autocomplete="address-line2" value="">
          <div class="err"></div>
        </div>
      </div>

      <div class="grid grid-3">
        <div>
          <label for="addr-cp" class="req">Code postal</label>
          <input id="addr-cp" type="text" autocomplete="postal-code" required value="">
          <div class="err"></div>
        </div>
        <div>
          <label for="addr-ville" class="req">Ville</label>
          <input id="addr-ville" type="text" autocomplete="address-level2" required value="">
          <div class="err"></div>
        </div>
        <div>
          <label for="addr-tel" class="req">T√©l√©phone</label>
          <input id="addr-tel" type="tel" autocomplete="tel" required value="">
          <div class="err"></div>
        </div>
      </div>

      <div class="grid">
        <div>
          <label for="addr-mail" class="req">Adresse e-mail</label>
          <input id="addr-mail" type="email" autocomplete="email" required value="louise@ennotex.fr">
          <div class="err"></div>
        </div>
      </div>

      <div class="hint">Les champs marqu√©s d‚Äôun * sont obligatoires.</div>
    </div>

    <hr/>

    <textarea id="comment" placeholder="Veuillez indiquer la raison du refus..."></textarea>

    <div class="buttons">
      <button class="approve" id="btn-approve" onclick="submitBAT(true)" disabled>‚úÖ Je valide ce BAT</button>
      <button class="reject"  id="btn-reject"  onclick="submitBAT(false)">‚ùå Je refuse ce BAT</button>
    </div>
  </div>

  <script>
    const approveBtn = document.getElementById('btn-approve');
    const rejectBtn  = document.getElementById('btn-reject');
    const commentBox = document.getElementById('comment');
    const page       = document.getElementById('page');

    const batKey  = "bat_status_En_attente_validation_BAT-90008-V1.pdf";
    let isSending = false;

    const countrySelect = document.getElementById('addr-country');
    const ccDisplay     = document.getElementById('cc-display');

    function lockForm(){
      page.classList.add('locked');
      approveBtn.disabled = true;
      rejectBtn.disabled = true;
      commentBox.disabled = true;
      document.querySelectorAll('input,select,textarea').forEach(i=>i.disabled = true);
    }

    function setError(el, msg){
      el.classList.add('error');
      const err = el.parentElement.querySelector('.err');
      if(err){ err.textContent = msg; err.style.display='block'; }
    }
    function clearError(el){
      el.classList.remove('error');
      const err = el.parentElement.querySelector('.err');
      if(err){ err.textContent=''; err.style.display='none'; }
    }

    function splitAddressToTwoLines(line1, line2, maxLen){
      const full = ((line1 || "") + " " + (line2 || "")).replace(/\s+/g, " ").trim();
      if(full.length <= maxLen) return { a1: full, a2: "" };

      let cut = full.lastIndexOf(" ", maxLen);
      if (cut === -1 || cut < 1) cut = maxLen;

      return {
        a1: full.slice(0, cut).trim(),
        a2: full.slice(cut).trim()
      };
    }

    // ‚úÖ split en live (sans bloquer la saisie)
    function applyAddressSplitLive(){
      const rue  = document.getElementById('addr-rue');
      const comp = document.getElementById('addr-comp');

      const parts = splitAddressToTwoLines(rue.value, comp.value, 35);

      // on ne modifie pas si √ßa ne d√©passe pas (pour ne pas "sauter" le curseur)
      // mais si √ßa d√©passe, on split et on pousse le reste dans compl√©ment
      if(((rue.value || "").replace(/\s+/g," ").trim()).length > 35){
        rue.value = parts.a1;
        comp.value = parts.a2;
      }
    }

    // ‚úÖ split forc√© juste avant envoi (garanti)
    function applyAddressSplitForce(){
      const rue  = document.getElementById('addr-rue');
      const comp = document.getElementById('addr-comp');
      const parts = splitAddressToTwoLines(rue.value, comp.value, 35);
      rue.value = parts.a1;
      comp.value = parts.a2;
    }

    function validateAddress(focusOnError){
      const f = {
        societe: document.getElementById('addr-societe'),
        nom:     document.getElementById('addr-nom'),
        pays:    document.getElementById('addr-country'),
        rue:     document.getElementById('addr-rue'),
        cp:      document.getElementById('addr-cp'),
        ville:   document.getElementById('addr-ville'),
        tel:     document.getElementById('addr-tel'),
        mail:    document.getElementById('addr-mail')
      };

      Object.values(f).forEach(clearError);
      let ok = true;

      if(!f.societe.value.trim()){ setError(f.societe,'Requis'); ok=false; }
      if(!f.nom.value.trim()){ setError(f.nom,'Requis'); ok=false; }
      if(!f.pays.value.trim()){ setError(f.pays,'S√©lectionnez un pays'); ok=false; }

      if(!f.rue.value.trim()){ setError(f.rue,'Requis'); ok=false; }

      // la ligne 1 doit √™tre <= 35 (on force le split avant)
      if(f.rue.value.trim().length > 35){ setError(f.rue,'Adresse trop longue'); ok=false; }

      const cpVal = f.cp.value.trim();
      if(!/^[A-Za-z0-9 -]{3,10}$/.test(cpVal)){ setError(f.cp,'Code postal invalide'); ok=false; }

      if(!f.ville.value.trim()){ setError(f.ville,'Requis'); ok=false; }

      const telVal = f.tel.value.trim().replace(/\s+/g,'');
      if(!/^[0-9+][0-9]{8,14}$/.test(telVal)){ setError(f.tel,'T√©l√©phone invalide'); ok=false; }

      const mailVal = f.mail.value.trim();
      if(!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(mailVal)){ setError(f.mail,'E-mail invalide'); ok=false; }

      if(!ok && focusOnError){
        const firstErr = document.querySelector('input.error, select.error');
        if(firstErr){ firstErr.scrollIntoView({behavior:'smooth',block:'center'}); firstErr.focus(); }
      }
      return ok;
    }

    function attachValidation(){
      document.querySelectorAll('#addr-societe,#addr-nom,#addr-country,#addr-rue,#addr-comp,#addr-cp,#addr-ville,#addr-tel,#addr-mail')
        .forEach(inp=>{
          inp.addEventListener('input', updateApproveState);
          inp.addEventListener('blur',  updateApproveState);
        });
    }

    function updateApproveState(){
      // on force le split avant de tester (sinon "adresse trop longue")
      applyAddressSplitForce();
      const ok = validateAddress(false);
      approveBtn.disabled = !ok;
      approveBtn.style.opacity = ok ? '1' : '.6';
      approveBtn.style.cursor  = ok ? 'pointer' : 'not-allowed';
    }

    function addressPayload(){
      return {
        societe:  document.getElementById('addr-societe').value.trim(),
        nom:      document.getElementById('addr-nom').value.trim(),
        adresse:  document.getElementById('addr-rue').value.trim(),  // ligne 1
        code_postal: document.getElementById('addr-cp').value.trim(),
        ville:    document.getElementById('addr-ville').value.trim(),
        telephone:document.getElementById('addr-tel').value.trim(),
        email:    document.getElementById('addr-mail').value.trim(),
        country_code: document.getElementById('addr-country').value.trim(),
        adresse_ligne2: (document.getElementById('addr-comp')?.value || "").trim() // ligne 2
      };
    }

    document.addEventListener('DOMContentLoaded', ()=>{
      // ‚úÖ pas de lock au chargement

      // Nettoie placeholders non remplac√©s
      document.querySelectorAll('input').forEach(inp=>{
        const v = (inp.value || '').replace(/\s+/g,' ').trim();
        if (/\{\{.+\}\}/.test(v)) inp.value = '';
        else inp.value = v;
      });

      ccDisplay.textContent = countrySelect.value ? countrySelect.value : "‚Äî";

      // split initial (si adresse longue)
      applyAddressSplitForce();

      countrySelect.addEventListener('change', ()=>{
        ccDisplay.textContent = countrySelect.value ? countrySelect.value : "‚Äî";
        updateApproveState();
      });

      document.getElementById('addr-rue').addEventListener('input', ()=>{
        applyAddressSplitLive();
        updateApproveState();
      });

      document.getElementById('addr-comp').addEventListener('input', ()=>{
        // si l'utilisateur ajoute du texte ici, on resplit l'ensemble
        updateApproveState();
      });

      attachValidation();
      updateApproveState();
    });

    function submitBAT(isValid){
      if (isSending) return;

      const cc = document.getElementById('addr-country').value.trim();
      if(!cc){
        alert("Veuillez s√©lectionner un pays.");
        return;
      }

      if(!isValid && !commentBox.value.trim()){
        alert("Merci d‚Äôindiquer la raison du refus.");
        commentBox.focus();
        return;
      }

      // ‚úÖ split garanti juste avant envoi
      applyAddressSplitForce();

      if(isValid && !validateAddress(true)){
        updateApproveState();
        return;
      }

      isSending = true;
      approveBtn.disabled = true;
      rejectBtn.disabled  = true;

      fetch("https://hook.eu1.make.com/1845ruicf13lufrf3jtnyn2438owof76",{
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body:JSON.stringify({
          status: isValid ? "valid√©" : "refus√©",
          commentaire: commentBox.value,
          bat: "En_attente_validation_BAT-90008-V1.pdf",
          Pays: cc,

          Express:"non",
          Point_relais:"non",
          Retrait_showroom:"non",
          Besoin_sp√©:"non",
          GLS:"non",
          id_dev_sellsy: "53124337",
          id_bat_slide: "1kLv6jl5jmBZbIaKqC-HshKT6JF8E1iNgynr367HxI14",
          id_opp_sellsy: "11238056",
          number_devis: "DEV-20260123-09008",
          company_name: "CLIENT TEST",
          name_client: "CLIENT TEST",
          id_company:"39021759",
          mail_client: "louise@ennotex.fr",
          prenom:"Leo",
GLS_UE:"oui",

          shipping_address: addressPayload()
        })
      }).then(async (res)=>{
        if(!res.ok){
          const txt = await res.text().catch(()=> "");
          alert("Erreur webhook: " + res.status + (txt ? (" / " + txt) : ""));
          throw new Error("Webhook error " + res.status);
        }

        localStorage.setItem(batKey, "submitted");
        lockForm();
        window.location.href = isValid ? "confirmation.html" : "refus.html";
      }).catch(()=>{
        isSending = false;
        approveBtn.disabled = false;
        rejectBtn.disabled  = false;
      });
    }
  </script>
</body>
</html>